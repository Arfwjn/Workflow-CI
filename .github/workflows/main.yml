name: CI Model Retraining using MLflow

on:
  push:
    branches:
      - main
    paths:
      - "MLProject/examScorePrediction_preprocessing/data_preprocessing.csv"
      - "MLProject/modelling.py"
  workflow_dispatch:

jobs:
  run_mlflow_project:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: 3.12.7
          activate-environment: mlflow-env
          environment-file: MLProject/conda.yaml

      - name: Run MLflow Project (Model Retraining)
        shell: bash -el {0}
        working-directory: MLProject
        run: |
          mlflow run . --experiment-name CI_Workflow_Klasifikasi_LogisticRegression

      - name: Get Latest Run ID
        id: get_run_id
        shell: bash -el {0}
        working-directory: MLProject
        run: |
          # Create Python script to get run ID
          cat > get_run_id.py << 'EOF'
          import mlflow
          import os

          try:
              # Set tracking URI
              mlflow.set_tracking_uri("file:./mlruns")
              
              # Get client
              client = mlflow.tracking.MlflowClient()
              
              # Get experiment by name
              experiment = client.get_experiment_by_name("CI_Workflow_Klasifikasi_LogisticRegression")
              
              if experiment is None:
                  print("Error: Experiment not found")
                  exit(1)
              
              # Get latest run
              runs = client.search_runs(
                  experiment_ids=[experiment.experiment_id],
                  order_by=["start_time DESC"],
                  max_results=1
              )
              
              if not runs:
                  print("Error: No runs found")
                  exit(1)
              
              run_id = runs[0].info.run_id
              print(f"Found Run ID: {run_id}")
              
              # Write to file for GitHub Actions
              with open(os.environ.get('GITHUB_OUTPUT', 'output.txt'), 'a') as f:
                  f.write(f"run_id={run_id}\n")
                  
          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          EOF

          # Run the script
          python get_run_id.py

      - name: Verify Run ID
        shell: bash -el {0}
        run: |
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
          if [ -z "$RUN_ID" ]; then
            echo "Error: Run ID is empty"
            exit 1
          fi
          echo "Run ID verified: $RUN_ID"

      - name: Build Docker Image using MLflow
        shell: bash -el {0}
        working-directory: MLProject
        run: |
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:latest"
          IMAGE_NAME_VERSIONED="${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:run-$RUN_ID"

          echo "Building Docker image for run: $RUN_ID"
          echo "Image name: $IMAGE_NAME"

          # Build Docker image
          mlflow models build-docker \
            -m "runs:/$RUN_ID/model" \
            -n "$IMAGE_NAME" \
            --enable-mlserver

          # Tag with versioned name
          docker tag "$IMAGE_NAME" "$IMAGE_NAME_VERSIONED"

          echo "Docker image built successfully"
          echo "Images created:"
          echo "$IMAGE_NAME"
          echo "$IMAGE_NAME_VERSIONED"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker Image to Docker Hub
        shell: bash -el {0}
        run: |
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:latest"
          IMAGE_NAME_VERSIONED="${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:run-$RUN_ID"

          echo "Pushing Docker images to Docker Hub..."

          docker push "$IMAGE_NAME"
          echo "Pushed: $IMAGE_NAME"

          docker push "$IMAGE_NAME_VERSIONED"
          echo "Pushed: $IMAGE_NAME_VERSIONED"
                    
          echo "All images pushed successfully"

      - name: Create Docker Hub Link File
        run: |
          DOCKERHUB_LINK="https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor"
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"

          cat > MLProject/docker_hub_link.txt << EOF
          Docker Hub Repository: $DOCKERHUB_LINK

          Latest Image:
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:latest

          Versioned Image (Run ID: $RUN_ID):
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/exam-score-predictor:run-$RUN_ID

          Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

          echo "Docker Hub link file created"
          cat MLProject/docker_hub_link.txt

      - name: Upload MLflow Artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-mlflow-artefacts-${{ github.run_id }}
          path: MLProject/mlruns/

      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push Updated Model Artefacts
        run: |
          MODEL_PATH='MLProject/examScorePrediction_preprocessing/lr_model.joblib'
          DOCKER_LINK='MLProject/docker_hub_link.txt'

          git add $MODEL_PATH $DOCKER_LINK || true
          git commit -m "CI: Automated model retraining, artefact update, and Docker image push [skip ci]" || echo "No changes to commit"
          git push

      - name: Workflow Success Message
        run: |
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
          echo "CI/CD Pipeline Completed Successfully"
